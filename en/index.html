<!DOCTYPE html>
<html lang="en">
<head>
    <title>node-odata Documentation</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <link rel="stylesheet" type="text/css" href="index.css">
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
</head>
<body>
<div id="header">
    <h1>node-odata Documentation</h1>
</div>

    <div id="sidebar">
<ul>
  <li><div><a href="#1-install">1) Install</a></div></li>
  <li><div><a href="#2-quick-start">2) Quick Start</a></div>
  <ul>
    <li><div><a href="#21-create">2.1 Create</a></div></li>
    <li><div><a href="#22-run">2.2 Run</a></div></li>
  </ul></li>
  <li><div><a href="#3-use-service">3) Use service</a></div>
  <ul>
    <li><div><a href="#31-create">3.1 Create</a></div></li>
    <li><div><a href="#32-modify">3.2 Modify</a></div></li>
    <li><div><a href="#33-query">3.3 Query</a></div></li>
    <li><div><a href="#34-remove">3.4 Remove</a></div></li>
  </ul></li>
  <li><div><a href="#4-odata-query">4) OData Query</a></div>
  <ul>
    <li><div><a href="#41-filter">4.1 $filter</a></div></li>
    <li><div><a href="#42-orderby">4.2 $orderby</a></div></li>
    <li><div><a href="#43-top">4.3 $top</a></div></li>
    <li><div><a href="#44-skip">4.4 $skip</a></div></li>
    <li><div><a href="#45-select">4.5 $select</a></div></li>
    <li><div><a href="#46-count">4.6 $count</a></div></li>
    <li><div><a href="#47-metadata">4.7 $metadata</a></div></li>
  </ul></li>
  <li><div><a href="#5-api">5) API</a></div>
  <ul>
    <li><div><a href="#51-resource">5.1 Resource</a></div></li>
    <li><div><a href="#52-function">5.2 Function</a></div></li>
    <li><div><a href="#53-set-get">5.3 set / get</a></div></li>
    <li><div><a href="#54-use">5.4 use</a></div></li>
    <li><div><a href="#55-listen">5.5 listen</a></div></li>
  </ul></li>
</ul>

    </div>
    <div id="content">

<h1>About node-odata</h1>
<div class="intro">


<p>Create awesome REST APIs abide by <a href="http://www.odata.org/">OData</a>.  Its purpose is to easier to creating APIs, make you more focus on business logic.</p>

<h2>What's the OData?</h2>

<p>The Open Data Protocol (OData) is a data access protocol for the web. OData provides a uniform way to query and manipulate data sets through CRUD operations (create, read, update, and delete).</p>

<h2>Why node-odata?</h2>

<p>node-odata support the OData powerful data query feature, and provided high concurrency of NodeJS, allowing developers to quickly create a REST API which provide a high-performance and support a series of complex queries.</p>

<h2>Current State</h2>

<p>node-odata is currently at an alpha stage, it is stable but not 100% feature complete. node-odata is written by ECMAScript 6 then compiled to ECMAScript 5 by babel. It currently have to dependent on MongoDB yet. The current target is to add more features and make other database adapter (eg. MySQL, PostgreSQL).</p>


</div>
<h1 id="1-install">1) Install</h1>

<p>node-odata depends on <a href="http://nodejs.org/">NodeJS</a> and <a href="http://www.mongodb.org/">MongoDB</a>, after installing the dependencies, run:</p>

<pre class="shell"><code>npm install node-odata
</code></pre>

<h1 id="2-quick-start">2) Quick Start</h1>

<p>We will create and run a simple OData services.</p>

<h2 id="21-create">2.1 Create</h2>

<p>After <strong>node-odata</strong> installation is complete, create * index.js * file and enter the following code:</p>

<pre><code>var odata = require('node-odata');

var server = odata('mongodb://localhost/my-app');

server.resource('books', { title: String, price: Number });

server.listen(3000);
</code></pre>

<h2 id="22-run">2.2 Run</h2>

<p>Enter the following command to start the OData service:</p>

<pre class="shell"><code>node index.js
</code></pre>

<p>Registers the following routes:</p>

<pre><code>GET    /books
GET    /books(:id)
POST   /books
PUT    /books(:id)
DELETE /books(:id)
</code></pre>

<h1 id="3-use-service">3) Use service</h1>

<p>You can use the <a href="http://zh.wikipedia.org/wiki/REST">REST</a> style HTTP requests for CURD.</p>

<h2 id="31-create">3.1 Create</h2>

<p>Use <strong>POST /resource</strong> to insert new data, it will return to the latest state of the resource.</p>

<pre class="shell"><code>curl -i -X POST -d '{"title": "title of book", "price": 19.99}' -H "Content-Type: application/json" http://127.0.0.1:3000/books
HTTP/1.1 201 Created
Content-Type: application/json; charset=utf-8
Content-Length: 83
Date: Sun, 11 Jan 2015 01:46:57 GMT
Connection: keep-alive

{
  "title": "title of book",
  "price": 19.99,
  "id": "44cc0da1-7372-43ed-a514-98d5fd6d8498"
}
</code></pre>

<h2 id="32-modify">3.2 Modify</h2>

<p>Use <strong>PUT /resource(:id)</strong> to modify existing data, it will return to the latest state of the resource.</p>

<pre class="shell"><code>curl -i -X PUT -d '{"title": "title of book", "price": 9.99}' -H "Content-Type: application/json" http://127.0.0.1:3000/books(44cc0da1-7372-43ed-a514-98d5fd6d8498)
HTTP/1.1 200 OK
Content-Type: application/json; charset=utf-8
Content-Length: 82
Date: Sun, 11 Jan 2015 01:50:11 GMT
Connection: keep-alive

{
  "title": "title of book",
  "price": 9.99,
  "id": "44cc0da1-7372-43ed-a514-98d5fd6d8498"
}
</code></pre>

<h2 id="33-query">3.3 Query</h2>

<p>Use <strong>GET /resource</strong> to query resources list, result will be returned in the value.</p>

<pre class="shell"><code>curl -i -X GET http://127.0.0.1:3000/books
HTTP/1.1 200 OK
Content-Type: application/json; charset=utf-8
Content-Length: 94
Date: Sun, 11 Jan 2015 01:52:49 GMT
Connection: keep-alive

{
  "value": [
    {
      "id": "44cc0da1-7372-43ed-a514-98d5fd6d8498",
      "title": "title of book",
      "price": 9.99
    }
  ]
}
</code></pre>

<p>Use <strong>GET /resource(:id)</strong> to querey specific resource.</p>

<pre class="shell"><code>curl -i -X GET http://127.0.0.1:3000/books(44cc0da1-7372-43ed-a514-98d5fd6d8498)
HTTP/1.1 200 OK
Content-Type: application/json; charset=utf-8
Content-Length: 82
Date: Sun, 11 Jan 2015 01:54:49 GMT
Connection: keep-alive

{
  "id": "44cc0da1-7372-43ed-a514-98d5fd6d8498",
  "title": "title of book",
  "price": 9.99
}
</code></pre>

<h2 id="34-remove">3.4 Remove</h2>

<p>Use <strong>DELETE /resource(:id)</strong> to remove specific resource.</p>

<pre class="shell"><code>curl -i -X DELETE http://127.0.0.1:3000/books(44cc0da1-7372-43ed-a514-98d5fd6d8498)
HTTP/1.1 200 OK
Content-Type: text/plain
Content-Length: 0
Date: Sun, 11 Jan 2015 01:56:21 GMT
Connection: keep-alive
</code></pre>

<h1 id="4-odata-query">4) OData Query</h1>

<p>This section describes how to use the OData protocol for query data set. Inquiry via a specific URL, you can filtering, sorting, pagination, etc. Each keyword start with  ($) character as a prefix.</p>

<p>Each keyword can be specified only once.</p>

<h2 id="41-filter">4.1 $filter</h2>

<p><strong>$filter</strong> for filter the data set.</p>

<p>Example: Returns a price below $ 10 books list</p>

<pre><code>http://host/books?$filter=price lt 10.00
</code></pre>

<p>node-odata has supported operators:</p>

<table>
<tbody>
<tr><td><strong>Operators</strong></td><td><strong>Description</strong></td><td><strong>Example</strong></td></tr>
<tr><td><strong>Comparison Operators</strong></td><td></td><td></td></tr>
<tr><td>eq</td><td>Equal</td><td>genre eq  'Fantasy'</td></tr>
<tr><td>ne</td><td>Not equal</td><td>author ne 'Kevin Kelly'</td></tr>
<tr><td>gt</td><td>Greater than</td><td>price gt 20</td></tr>
<tr><td>ge</td><td>Greater than or equal</td><td>price ge 10</td></tr>
<tr><td>lt</td><td>Less than</td><td>price lt 20</td></tr>
<tr><td>le</td><td>Less than or equal</td><td>price le 100</td></tr>
<tr><td><strong>Logical Operators</strong></td><td></td><td></td></tr>
<tr><td>and</td><td>Logical and</td><td>Price le 200 and Price gt 3.5</td></tr>
</tbody>
</table>

<p>node-odata also built a series of functions to support complex queries:</p>

<table>
<tbody>
<tr><td><strong>functions</strong></td><td><strong>Example</strong></td></tr>
<tr><td><strong>String Functions</strong></td><td></td></tr>
<tr><td>contains</td><td>contains('Alfreds',CompanyName)</td></tr>
<tr><td>indexof</td><td>indexof(description,'.NET') gt 0</td></tr>
<tr><td><strong>Date Functions</strong></td><td></td></tr>
<tr><td>year</td><td>year(publish_date) eq 2000</td></tr>
</tbody>
</table>

<p>*Note: More operators and functions will be implemented in the future. All the operators and functions defined in the OData protocol Refer to <a href="http://docs.oasis-open.org/odata/odata/v4.0/odata-v4.0-part1-protocol.html#_Toc406398301">here</a>.</p>

<h2 id="42-orderby">4.2 $orderby</h2>

<p><strong>$orderby</strong> for sort by fields.</p>

<p>It can use a comma-separated to multiple sorting.</p>

<p>The expression can include the suffix asc for ascending or desc for descending, separated from the property name by one or more spaces. If asc or desc is not specified, <code>asc</code> will be default.</p>

<p>Example: return all Books ordered by publish date in ascending order, then by price in descending order.</p>

<pre><code>http://host/books?$orderby=publish_date asc, price desc
</code></pre>

<h2 id="43-top">4.3 $top</h2>

<p><strong>$top</strong> for limits the number of items returned from a collection.</p>

<p>Example: return only the first five books of the Books entity set.</p>

<pre><code>http://host/books?$top=5
</code></pre>

<h2 id="44-skip">4.4 $skip</h2>

<p><strong>$skip</strong> for excludes the first n items of the queried collection from the result.</p>

<p>Example: return books starting with the 6th book of the Books entity set</p>

<pre><code>http://host/books?$skip=6
</code></pre>

<p>Where $top and $skip are used together, $skip MUST be applied before $top, regardless of the order in which they appear in the request.</p>

<p>Example: return the third through seventh books of the Books entity set</p>

<pre><code>http://host/books?$top=5&amp;$skip=2
</code></pre>

<h2 id="45-select">4.5 $select</h2>

<p><strong>$select</strong> for requests that the service return only the properties requested by the client. </p>

<p>Example:  return title and price of resource only.</p>

<pre><code>http://host/books?$select=title, price
</code></pre>

<h2 id="46-count">4.6 $count</h2>

<p>The <strong>$count</strong> with a value of true specifies that the total count of items within a collection matching the request be returned along with the result.</p>

<p>The <strong>$count</strong> system query option ignores any <strong>$top</strong>, <strong>$skip</strong>, or <strong>$expand</strong> query options, and returns the total count of results across all pages including only those results matching any specified <strong>$filter</strong> and <strong>$search</strong>.</p>

<p>Example: return, along with the results, the total number of books in the collection</p>

<pre><code>http://host/books?$count=true
</code></pre>

<h2 id="47-metadata">4.7 $metadata</h2>

<p>TODO</p>

<h1 id="5-api">5) API</h1>

<p>This section describes the node-odata <strong>fluent API</strong>.</p>

<h2 id="51-resource">5.1 Resource</h2>

<p>Register a Resource in OData service so that it can be using the REST API to invoke.</p>

<h3 id="params">Params</h3>

<p>params:</p>

<table>
<tbody>
<tr><td><strong>Name</strong></td><td><strong>Type</strong></td><td><strong>Details</strong></td></tr>
<tr><td>url</td><td>string</td><td>URL of Resource</td></tr>
<tr><td>model</td><td>object</td><td>Data structure definitions of Resource</td></tr>
</tbody>
</table>

<h3 id="example">example</h3>

<p><strong>Node</strong>: In addition to the url and model, other parameters are optional</p>

<pre><code>server.resource('book', {
  // Resource aata structure definitions
  // Optional types: String, Number, Date, Boolean, Array
  author: String,
  description: String,
  genre: String,
  id: String,
  price: Number,
  publish_date: Date,
  title: String
})
// configure GET /resource(:id)
.get()
  .auth(function (req) {...}) // authorization verification, if false, client will get 401
  .before(function (entity) {...}) // before callback
  .after(function (entity) {...}) // after callback
// configure GET /resource
.list()
  .auth(function (req) {...})
  .before(function () {...})
  .after(function (data) {...})
// configure POST /resource
.post()
  .auth(function (req) {...})
  .before(function (entity) {...})
  .after(function (originEntity, newEntity) {...})
// configure PUT /resource(:id)
.put()
  .auth(function (req) {...})
  .before(function (entity) {...})
  .after(function (entity) {...})
// configure DELETE /resource(:id)
.delete()
  .auth(function (req) {...})
  .before(function (entity) {...})
  .after(function (entity) {...})
// configure all of the above request
.all()
  .auth(function (req) {...})
  .before(function (entity) {...})
  .after(function (entity) {...})
// 设置 OData Action
// 第一个参数为 action url, 第二个参数为 callback
// first param is action url, second param is action's callback
// when POST /resource(:id)/50-off
.action('/50off', function(req, res, next){...})
// default orderby
.orderBy('date desc') 
// max skip limit
.maxSkip(10000) 
// max top limit
.maxTop(100)
</code></pre>

<h2 id="52-function">5.2 Function</h2>

<p>Register a WEB API in OData service, for processing custom logic.</p>

<pre><code>server.get(url, callback, auth);
server.put(url, callback, auth);
server.post(url, callback, auth);
server.delete(url, callback, auth);
</code></pre>

<h3 id="params-2">Params</h3>

<table>
<tbody>
<tr><td><strong>Name</strong></td><td><strong>Type</strong></td><td><strong>Details</strong></td></tr>
<tr><td>url</td><td>string</td><td>Url of WEB API</td></tr>
<tr><td>callback</td><td>function</td><td>function handler</td></tr>
<tr><td>auth</td><td>function (optional)</td><td>Authorization verification</td></tr>
</tbody>
</table>

<h4 id="example-2">Example</h4>

<p>odata.get('/server-time', function(req, res, next) {
      res.json({
        date: new Date()
      });
  });</p>

<h2 id="53-set-get">5.3 set / get</h2>

<p>Some basic configuration for node-odata.</p>

<table>
<tbody>
<tr><td><strong>Allow Key</strong></td><td><strong>Value Type</strong></td><td><strong>Details</strong></td></tr>
<tr><td>db</td><td>string</td><td>Configure mongoDB database Address</td></tr>
<tr><td>prefix</td><td>string</td><td>Configure the URL prefix, the default is '/'</td></tr>
<tr><td>maxTop</td><td>int</td><td>Setting the global maximum number of allowed Query</td></tr>
<tr><td>maxSkip</td><td>int</td><td>Setting the global maximum number of allowed skipped</td></tr>
</tbody>
</table>

<h2 id="54-use">5.4 use</h2>

<p>Use <code>server.use</code> to add  <strong>Express</strong> middleware.</p>

<h2 id="55-listen">5.5 listen</h2>

<p>On a given host and port monitoring requests.</p>

    </div> <!-- #content -->
<script type="text/javascript" charset="utf-8">
$(function() {
    var headerHeight = $("#header").height();

    var sections = $("#content h1[id], #content h2[id]");
    var sectionOffsets = [];
    var slack = 100;  // Give the section scroll some slack (in pixels).
    sections.each(function(elem) {
        sectionOffsets.push($(this).offset().top - headerHeight - slack);
    });

    var currSectionIdx = -1;
    function getSectionIdx(scrollDistance) {
        if (scrollDistance < sectionOffsets[0]) {
            return -1;
        } else {
            for (var id = sectionOffsets.length; id > 0; id--) {
                if (scrollDistance > sectionOffsets[id - 1]) {
                    return id - 1;
                    break;
                }
            }
        }
    }

    /** {{{ http://code.activestate.com/recipes/577787/ (r2) */
    _slugify_strip_re = /[^\w\s-]/g;
    _slugify_hyphenate_re = /[-\s]+/g;
    function slugify(s) {
      s = s.replace(_slugify_strip_re, '').trim().toLowerCase();
      s = s.replace(_slugify_hyphenate_re, '-');
      return s;
    }
    /** end of http://code.activestate.com/recipes/577787/ }}} */

    /* See <https://github.com/trentm/restdown/issues/11>. */
    function safechars(s) {
      return s.replace(_slugify_strip_re, '');
    }

    $("#content").scroll(function() {
        var scrollDistance = $("#content").scrollTop();
        var sectionIdx = getSectionIdx(scrollDistance);

        if (sectionIdx !== currSectionIdx) {
            $("#sidebar li>div").removeClass("current");
            currSectionIdx = sectionIdx;
            if (currSectionIdx >= 0) {
                var heading = $(sections[currSectionIdx]).text();
                var possibleAnchors = [
                    slugify(heading), // h1 or non-method h2
                    heading.replace(/ /g, '-'), // h2 method, just name or just endpoint
                    heading.slice(0, heading.lastIndexOf(' (')).trimRight().replace(/ /g, '-'), // h2 method, name and endpoint
                ];
                for (var i=0; i < possibleAnchors.length; i++) {
                    var anchor = safechars(possibleAnchors[i]);
                    try {
                        $("#sidebar a[href=#" + anchor + "]").parent().addClass("current");
                    } catch (e) {
                        /* Ignore error if no such element. */
                        console.log(e)
                    }
                }
            }
        }
    });
});
</script>

</body>
</html>
